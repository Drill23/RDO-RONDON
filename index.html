<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador de Rendimento</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; text-align: center; }
    .menu, .voltar, .acoes { margin: 20px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
    .info { font-size: 18px; margin: 10px 0; }
    table { margin: 20px auto; border-collapse: collapse; width: 95%; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #ddd; }
    .positivo { color: green; font-weight: bold; }
    .negativo { color: red; font-weight: bold; }
    canvas { max-width: 100%; margin-top: 30px; background: #fff; }
  </style>
</head>
<body>
  <h1>Visualizador de Rendimento</h1>
  <div class="menu">
    <button onclick="mostrar('turno1')">üîµ Primeiro Turno</button>
    <button onclick="mostrar('turno2')">üü¢ Segundo Turno</button>
    <button onclick="mostrar('comparar')">üü° Comparar Turnos</button>
    <button onclick="mostrar('semanal')">üü£ An√°lise Semanal</button>
    <button onclick="exportarPDF()">üìÑ Exportar em PDF</button>
  </div>

  <div id="info" class="info"></div>
  <div id="status">Carregando arquivos...</div>
  <div class="acoes"><button class="voltar" onclick="voltarMenu()" style="display:none;">üîô Voltar ao Menu</button></div>
  <div id="resultado"></div>
  <canvas id="graficoComparativo" style="display:none;"></canvas>

<script>
  let arquivos = [], dados = {};
  let diario = [], semanal = [];

  async function carregarJSON(nome) {
    const res = await fetch(nome);
    return await res.json();
  }

  function extrairInfo(nome) {
    const partes = nome.split(".");
    const tipo = nome.includes("semana") ? "semanal" : "diario";
    const turno = partes.includes("turno1") ? "Turno 1" : "Turno 2";
    let diaSemana = partes[0];
    let data = partes.length >= 5 ? partes[2] + "/" + partes[3] + "/20" + partes[4] : "";
    return { nome, tipo, diaSemana, data, turno };
  }

  function voltarMenu() {
    document.querySelector(".menu").style.display = 'block';
    document.querySelector(".voltar").style.display = 'none';
    document.getElementById("info").innerHTML = "";
    document.getElementById("resultado").innerHTML = "";
    document.getElementById("graficoComparativo").style.display = "none";
  }

  async function exportarPDF() {
    const element = document.body;
    html2pdf().from(element).save('relatorio.pdf');
  }

  function mostrarCabecalho(info1, info2 = null) {
    const div = document.getElementById("info");
    if (info2) {
      div.innerHTML = `üìä Comparativo de ${info1.diaSemana}, ${info1.data}<br>üïê ${info1.turno} vs ${info2.turno}`;
    } else {
      div.innerHTML = `üìÑ Relat√≥rio de ${info1.turno}<br>üìÖ ${info1.diaSemana}, ${info1.data}`;
    }
  }

  function mostrarTabela(dados, dupla = false) {
    let html = "<table><tr><th>Produto</th>";
    if (dupla) {
      html += "<th>Turno 1 (%)</th><th>Turno 2 (%)</th><th>Dif. (%)</th><th>Dif. (Kg)</th><th>Dif. (Caixas)</th><th>Melhor Turno</th></tr>";
      const labels = [], dados1 = [], dados2 = [];
      let v1 = 0, v2 = 0, emp = 0;

      for (let i = 0; i < dados[0].length; i++) {
        const a = dados[0][i], b = dados[1][i];
        const diffPerc = (b.realizado - a.realizado).toFixed(3);
        const diffKg = (b.quilos - a.quilos).toFixed(2);
        const diffCx = Math.ceil(b.caixas) - Math.ceil(a.caixas);
        const melhor = b.realizado > a.realizado ? (++v2, "Turno 2 ‚úÖ") : (b.realizado < a.realizado ? (++v1, "Turno 1 ‚úÖ") : (++emp, "Empate"));
        const classe = diffPerc >= 0 ? 'positivo' : 'negativo';
        html += `<tr><td>${a.produto}</td><td>${a.realizado.toFixed(3)}%</td><td>${b.realizado.toFixed(3)}%</td><td class="${classe}">${diffPerc}%</td><td>${diffKg}</td><td>${diffCx}</td><td>${melhor}</td></tr>`;
        labels.push(a.produto);
        dados1.push(a.realizado);
        dados2.push(b.realizado);
      }

      html += `</table><p><strong>Resumo Final:</strong> Turno 1 venceu ${v1} itens, Turno 2 venceu ${v2} itens, Empates: ${emp}.</p>`;
      document.getElementById("graficoComparativo").style.display = "block";
      desenharGrafico(labels, dados1, dados2);
    } else {
      html += "<th>Meta (%)</th><th>Realizado (%)</th><th>Diferen√ßa (%)</th><th>Meta Atingida</th><th>Quilos</th><th>Caixas</th></tr>";
      for (let item of dados) {
        const diff = parseFloat(item.diferencaPercentual);
        const classe = diff >= 0 ? 'positivo' : 'negativo';
        const atingiu = item.atingiuMeta ? "‚úÖ" : "‚ùå";
        html += `<tr><td>${item.produto}</td><td>${item.meta.toFixed(3)}%</td><td>${item.realizado.toFixed(3)}%</td><td class="${classe}">${diff > 0 ? '+' : ''}${item.diferencaPercentual}%</td><td>${atingiu}</td><td>${item.quilos.toFixed(2)}</td><td>${Math.ceil(item.caixas)}</td></tr>`;
      }
    }
    document.getElementById("resultado").innerHTML = html;
  }

  function desenharGrafico(labels, dados1, dados2) {
    const ctx = document.getElementById("graficoComparativo").getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: 'Turno 1', backgroundColor: 'rgba(54, 162, 235, 0.7)', data: dados1 },
          { label: 'Turno 2', backgroundColor: 'rgba(75, 192, 192, 0.7)', data: dados2 }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Compara√ß√£o de Realizado (%) por Produto' }
        }
      }
    });
  }

  async function mostrar(tipo) {
    document.querySelector(".menu").style.display = 'none';
    document.querySelector(".voltar").style.display = 'inline-block';
    document.getElementById("graficoComparativo").style.display = "none";

    if (tipo === "turno1" && diario[0]) {
      mostrarCabecalho(extrairInfo(diario[0]));
      mostrarTabela(dados.diario1);
    } else if (tipo === "turno2" && diario[1]) {
      mostrarCabecalho(extrairInfo(diario[1]));
      mostrarTabela(dados.diario2);
    } else if (tipo === "comparar" && diario.length === 2) {
      mostrarCabecalho(extrairInfo(diario[0]), extrairInfo(diario[1]));
      mostrarTabela([dados.diario1, dados.diario2], true);
    } else if (tipo === "semanal" && semanal.length === 2) {
      mostrarCabecalho(extrairInfo(semanal[0]), extrairInfo(semanal[1]));
      mostrarTabela([dados.semanal1, dados.semanal2], true);
    }
  }

  async function iniciar() {
    const index = await carregarJSON("index.json");
    for (const nome of index.arquivos) {
      if (nome.includes("turno1") && nome.includes("semana")) {
        semanal[0] = nome;
        dados.semanal1 = await carregarJSON(nome);
      } else if (nome.includes("turno2") && nome.includes("semana")) {
        semanal[1] = nome;
        dados.semanal2 = await carregarJSON(nome);
      } else if (nome.includes("turno1")) {
        diario[0] = nome;
        dados.diario1 = await carregarJSON(nome);
      } else if (nome.includes("turno2")) {
        diario[1] = nome;
        dados.diario2 = await carregarJSON(nome);
      }
    }
    document.getElementById("status").style.display = 'none';
  }

  iniciar();
</script>
</body>
</html>
