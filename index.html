
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador Completo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; text-align: center; }
    table { margin: 20px auto; border-collapse: collapse; width: 95%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #ddd; }
    .positivo { color: green; font-weight: bold; }
    .negativo { color: red; font-weight: bold; }
    iframe, img { max-width: 95%; height: 80vh; border: 2px solid #ccc; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    canvas { max-width: 100%; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Visualizador Inteligente de Arquivos</h1>
  <div id="status">Carregando...</div>
  <div id="resultado"></div>
  <canvas id="graficoComparativo" style="display:none;"></canvas>

<script>
  async function arquivoExiste(nome) {
    try {
      const res = await fetch(nome, { method: 'HEAD' });
      return res.ok;
    } catch {
      return false;
    }
  }

  async function carregarJSON(nome) {
    const res = await fetch(nome);
    return await res.json();
  }

  function mostrarImagem() {
    document.getElementById("status").innerText = "";
    document.getElementById("resultado").innerHTML = '<img src="atual.png" alt="Imagem do Dia">';
  }

  function mostrarPDF() {
    document.getElementById("status").innerText = "";
    document.getElementById("resultado").innerHTML = '<iframe src="atual.pdf" frameborder="0"></iframe>';
  }

  function mostrarTabelaSimples(dados) {
    document.getElementById("status").innerText = "";
    let html = "<table><tr><th>Produto</th><th>Meta (%)</th><th>Realizado (%)</th><th>Diferença (%)</th><th>Meta Atingida</th><th>Quilos</th><th>Caixas</th></tr>";
    for (let item of dados) {
      const diff = parseFloat(item.diferencaPercentual);
      const classe = diff >= 0 ? 'positivo' : 'negativo';
      const atingiu = item.atingiuMeta ? "✅" : "❌";
      html += `<tr>
        <td>${item.produto}</td>
        <td>${item.meta.toFixed(3)}%</td>
        <td>${item.realizado.toFixed(3)}%</td>
        <td class="${classe}">${diff > 0 ? '+' : ''}${item.diferencaPercentual}</td>
        <td>${atingiu}</td>
        <td>${item.quilos.toFixed(2)}</td>
        <td>${Math.ceil(item.caixas)}</td>
      </tr>`;
    }
    html += "</table>";
    document.getElementById("resultado").innerHTML = html;
  }

  function mostrarComparacao(turno1, turno2) {
    let html = "<table><tr><th>Produto</th><th>Turno 1 (%)</th><th>Turno 2 (%)</th><th>Dif. (%)</th><th>Dif. (Kg)</th><th>Dif. (Caixas)</th><th>Melhor Turno</th></tr>";
    const labels = [], dados1 = [], dados2 = [];

    for (let i = 0; i < turno1.length; i++) {
      const t1 = turno1[i], t2 = turno2[i];
      const diffPerc = (t2.realizado - t1.realizado).toFixed(2);
      const diffKg = (t2.quilos - t1.quilos).toFixed(2);
      const diffCx = (t2.caixas - t1.caixas).toFixed(2);
      const melhor = t2.realizado > t1.realizado ? "Turno 2 ✅" : (t2.realizado < t1.realizado ? "Turno 1 ✅" : "Empate");
      const classe = diffPerc >= 0 ? 'positivo' : 'negativo';

      html += `<tr>
        <td>${t1.produto}</td>
        <td>${t1.realizado.toFixed(2)}</td>
        <td>${t2.realizado.toFixed(2)}</td>
        <td class="${classe}">${diffPerc}</td>
        <td>${diffKg}</td>
        <td>${diffCx}</td>
        <td>${melhor}</td>
      </tr>`;

      labels.push(t1.produto);
      dados1.push(t1.realizado);
      dados2.push(t2.realizado);
    }

    html += "</table>";
    document.getElementById("resultado").innerHTML = html;
    desenharGrafico(labels, dados1, dados2);
  }

  function desenharGrafico(labels, dados1, dados2) {
    const canvas = document.getElementById("graficoComparativo");
    canvas.style.display = 'block';
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: 'Turno 1', backgroundColor: 'rgba(54, 162, 235, 0.7)', data: dados1 },
          { label: 'Turno 2', backgroundColor: 'rgba(75, 192, 192, 0.7)', data: dados2 }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Comparação de Realizado (%) por Produto' }
        }
      }
    });
  }

  async function iniciar() {
    const existeT1 = await arquivoExiste("turno1.json");
    const existeT2 = await arquivoExiste("turno2.json");
    const existeAtualJSON = await arquivoExiste("atual.json");
    const existePDF = await arquivoExiste("atual.pdf");
    const existePNG = await arquivoExiste("atual.png");

    if (existeT1 && existeT2) {
      const t1 = await carregarJSON("turno1.json");
      const t2 = await carregarJSON("turno2.json");
      mostrarComparacao(t1, t2);
    } else if (existeAtualJSON) {
      const dados = await carregarJSON("atual.json");
      mostrarTabelaSimples(dados);
    } else if (existePDF) {
      mostrarPDF();
    } else if (existePNG) {
      mostrarImagem();
    } else {
      document.getElementById("status").innerText = "Nenhum arquivo encontrado para exibição.";
    }
  }

  iniciar();
</script>
</body>
</html>
